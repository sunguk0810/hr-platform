server:
  port: 8080

spring:
  application:
    name: gateway-service
  main:
    web-application-type: reactive
  config:
    import: optional:configserver:http://${CONFIG_SERVER_HOST:localhost}:8888
  cloud:
    config:
      enabled: ${SPRING_CLOUD_CONFIG_ENABLED:false}
      fail-fast: false
    loadbalancer:
      enabled: false
    discovery:
      enabled: false
    gateway:
      globalcors:
        cors-configurations:
          '[/**]':
            allowed-origin-patterns: "*"
            allowed-methods: "*"
            allowed-headers: "*"
            allow-credentials: true
      # Disable discovery locator (using static routes)
      discovery:
        locator:
          enabled: false
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials
      # CORS handled by GlobalCorsConfig.java

      routes:
        # Auth Service
        - id: auth-service
          uri: ${AUTH_SERVICE_URL:http://localhost:8081}
          predicates:
            - Path=/api/v1/auth/**
          filters:
            - RewritePath=/api/v1/auth/(?<segment>.*), /api/v1/auth/${segment}

        # Tenant Service
        - id: tenant-service
          uri: ${TENANT_SERVICE_URL:http://localhost:8082}
          predicates:
            - Path=/api/v1/tenants/**
          filters:
            - RewritePath=/api/v1/tenants/(?<segment>.*), /api/v1/tenants/${segment}

        # MDM Service (includes Menu management)
        - id: mdm-service
          uri: ${MDM_SERVICE_URL:http://localhost:8087}
          predicates:
            - Path=/api/v1/mdm/**, /api/v1/menus/**, /api/v1/admin/menus/**
          filters:
            - RewritePath=/api/v1/(?<segment>.*), /api/v1/${segment}

        # Organization Service
        - id: organization-service
          uri: ${ORGANIZATION_SERVICE_URL:http://localhost:8083}
          predicates:
            - Path=/api/v1/organizations/**, /api/v1/departments/**, /api/v1/positions/**, /api/v1/grades/**, /api/v1/announcements/**, /api/v1/committees/**, /api/v1/headcounts/**
          filters:
            - RewritePath=/api/v1/(?<segment>.*), /api/v1/${segment}

        # Employee Service (includes Transfers)
        - id: employee-service
          uri: ${EMPLOYEE_SERVICE_URL:http://localhost:8084}
          predicates:
            - Path=/api/v1/employees/**, /api/v1/condolences/**, /api/v1/transfers/**
          filters:
            - RewritePath=/api/v1/(?<segment>.*), /api/v1/${segment}

        # Attendance Service
        - id: attendance-service
          uri: ${ATTENDANCE_SERVICE_URL:http://localhost:8085}
          predicates:
            - Path=/api/v1/attendances/**, /api/v1/leaves/**, /api/v1/overtimes/**
          filters:
            - RewritePath=/api/v1/(?<segment>.*), /api/v1/${segment}

        # Approval Service
        - id: approval-service
          uri: ${APPROVAL_SERVICE_URL:http://localhost:8086}
          predicates:
            - Path=/api/v1/approvals/**
          filters:
            - RewritePath=/api/v1/approvals/(?<segment>.*), /api/v1/approvals/${segment}

        # Notification Service
        - id: notification-service
          uri: ${NOTIFICATION_SERVICE_URL:http://localhost:8088}
          predicates:
            - Path=/api/v1/notifications/**
          filters:
            - RewritePath=/api/v1/notifications/(?<segment>.*), /api/v1/notifications/${segment}

        # File Service
        - id: file-service
          uri: ${FILE_SERVICE_URL:http://localhost:8089}
          predicates:
            - Path=/api/v1/files/**
          filters:
            - RewritePath=/api/v1/(?<segment>.*), /api/v1/${segment}

        # Recruitment Service
        - id: recruitment-service
          uri: ${RECRUITMENT_SERVICE_URL:http://localhost:8093}
          predicates:
            - Path=/api/v1/jobs/**, /api/v1/applications/**, /api/v1/interviews/**, /api/v1/offers/**
          filters:
            - RewritePath=/api/v1/(?<segment>.*), /api/v1/${segment}

        # Appointment Service
        - id: appointment-service
          uri: ${APPOINTMENT_SERVICE_URL:http://localhost:8091}
          predicates:
            - Path=/api/v1/appointments/**
          filters:
            - RewritePath=/api/v1/(?<segment>.*), /api/v1/${segment}

        # Certificate Service
        - id: certificate-service
          uri: ${CERTIFICATE_SERVICE_URL:http://localhost:8092}
          predicates:
            - Path=/api/v1/certificates/**
          filters:
            - RewritePath=/api/v1/(?<segment>.*), /api/v1/${segment}

  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: ${KEYCLOAK_ISSUER_URI:http://localhost:8180/realms/hr-saas}

  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6381}
      password: ${REDIS_PASSWORD:redis_password}

resilience4j:
  circuitbreaker:
    configs:
      default:
        sliding-window-size: 10
        minimum-number-of-calls: 5
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10000
        permitted-number-of-calls-in-half-open-state: 3
  timelimiter:
    configs:
      default:
        timeout-duration: 30s

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,gateway
  endpoint:
    gateway:
      enabled: true
    health:
      show-details: always
  health:
    discovery:
      enabled: false
    config:
      enabled: false

gateway:
  rate-limit:
    enabled: true
    default-max-requests: 100
    default-window: 1m
    paths:
      /api/v1/auth/login:
        max-requests: 10
        window: 1m
      /api/v1/auth/password/reset:
        max-requests: 5
        window: 1m
      /api/v1/files/**:
        max-requests: 50
        window: 1m
    role-based-limits:
      SYSTEM_ADMIN: 1000
      TENANT_ADMIN: 500
      HR_MANAGER: 300

jwt:
  secret: ${JWT_SECRET:hr-saas-secret-key-for-jwt-token-signing-minimum-256-bits-required}

logging:
  level:
    root: INFO
    com.hrsaas: DEBUG
    org.springframework.cloud.gateway: DEBUG
    org.springframework.security: DEBUG
    org.springframework.web.cors: TRACE
    org.springframework.web.filter: TRACE
    org.springframework.web.server.adapter: TRACE
