# Approval Service: Backend <> Frontend Gap Analysis (Updated)

> **최종 업데이트**: 2026-02-09
> **대상 모듈**: Approval Service (전자결재)

---

## 1. 확정된 비즈니스 정책 (Finalized Business Policies)

개발 및 통합 시 다음의 확정된 정책을 반드시 준수한다.

### 1.1 결재선 및 미리보기 (GAP-01)
- **공석 처리**: 결재선 해석 중 결재자(부서장 등)를 찾을 수 없는 경우 **상신 불가** 처리를 원칙으로 한다. (데이터 정합성 우선)
- **수정 범위**: 시스템이 생성한 **필수 결재선은 수정이 불가**하며, 참조(CC) 선에 대해서만 추가/삭제가 가능하다.

### 1.2 반송 및 반려 (GAP-02)
- **반송 정책**: 결재 진행 중(팀장 > 부문장 > 대표) '대표'가 반송한 경우, 문서는 **첫 번째 단계(팀장)부터 다시 결재**를 받아야 한다. (재상신 시 모든 라인 초기화)

### 1.3 문서 수정 및 상태 (GAP-03)
- **수정 제약**: 상신 직후(`PENDING`)를 포함하여, 상신된 이후의 문서는 직접 수정이 불가하다.
- **수정 프로세스**: 반드시 **회수(Recall) -> 수정(Edit) -> 재상신(Submit)**의 단계를 거쳐야 한다.

### 1.4 일괄 처리 (GAP-04)
- **범위**: 일괄 승인만 허용하며, **일괄 반려는 허용하지 않는다.**
- **실패 처리**: 부분 실패를 허용하되, UI에서 실패한 문서별로 **정확한 오류 원인(사유)**을 사용자에게 노출해야 한다.

### 1.5 위임 및 대결 (GAP-05, 06, 07)
- **규칙 수정**: 위임 규칙은 생성이후 수정이 불가하다. 변경이 필요한 경우 **기존 규칙 만료(Expire) 후 신규 생성** 프로세스를 따른다.
- **전결 충돌**: 전결 규정과 기안자가 충돌할 경우(본인 전결 건 등), 해당 단계를 건너뛰고 **차상위자에게 결재권**이 넘어간다.
- **순환 참조**: 대결자 지정 시 시스템이 순환 참조(A->B->A)를 체크하여 에러를 발생시키고 설정을 차단해야 한다.

### 1.6 기한 관리 (GAP-09)
- **기한 도래**: 결재 기한 초과 시 시스템은 자동 승인/반려 등의 상태 변경을 하지 않으며, 결재자에게 **단순 독촉 알림**만 발송한다.

---

## 2. 상세 Gap 분석 및 실행 계획

| ID | Gap 항목 | 우선순위 | 실행 계획 |
|----|----------|----------|-----------|
| GAP-01 | 결재선 미리보기 | **HIGH** | `POST /templates/{id}/preview` 구현. 공석 시 에러코드 반환. |
| GAP-02 | 반송 기능 | **HIGH** | `RETURNED` 상태 추가 및 State Machine에 '전체 초기화' 액션 구현. |
| GAP-03 | 임시저장 수정 | **MEDIUM** | `PUT /approvals/{id}` API 추가 (DRAFT 상태 체크). |
| GAP-04 | 일괄 승인 | **MEDIUM** | `POST /batch/approve` 구현. 개별 트랜잭션 처리 및 결과 리스트 반환. |
| GAP-07 | 자가결재/순순환 | **CRITICAL** | Delegation 설정 시 및 결재선 생성 시 Validation 로직 강화. |

---

## 3. 기술적 영향도 평가

1.  **State Machine (Spring StateMachine)**: `RETURNED` 상태와 `SUBMIT`(재상신) 시 모든 `ApprovalLine`을 `WAITING`으로 리셋하는 `Action` 정의 필요.
2.  **Validation Layer**: 결재선 생성 서비스(`ApprovalLineResolver`)에서 차상위자 에스컬레이션 로직 로직 추가.
3.  **Delegation Service**: 위임 규칙 저장 전 Recursive Query 또는 로직을 통한 순환 참조 검증 로직 추가.